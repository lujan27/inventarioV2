<%- include('../includes/sidebar.ejs') %>
<%- include('../includes/header.ejs') %>


<body>
    <section class="home-section">
        <%- include('../includes/nav.ejs') %>
        

    <div class="container mt-2">
        <%- include('../includes/alerts.ejs') %>

        
        <% switch(user.role){
            case 'administrador': %> 

       
        <% break

        case 'coordinador': %>
            <!-- Añadir las diferentes rutas para el coordinador como usuarios, inventario etc. -->
        <% break

        case 'usuario': %>
            <!-- Hacer lo mismo que con el coordinador -->
        <%break
         } %> 
        <% if (user.role == 'administrador') { %> 
        <div class="container-fluid row" style="padding-top: 1cm;">
            
            <div class="col-2">
                <a href="/admin/maincatalogue" class="btn btn-outline-success mb-4" data-toggle="tooltip" title="Agrega un nuevo producto al catalogo">
                    <i class='bx bx-spa'></i>
                    Agregar producto al catalogo
                </a>
            </div>

        </div>
        <% } %> 

        <h2>Catalogo de productos</h2>
        
        <div class="text-center">
            <table id="inventoryTable" data-column-orderable="1, 1, 1,0" class="w-100 data-table table table-lg table-striped">
                <thead class="thead">
                    <tr>
                        <th scope="col">Nombre</th>
                        <th scope="col">Descripción</th>
                        <th scope="col">Unidad de medida</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% catalogue.forEach((prod, i) => { %> 
                    <tr>
                        <td class="product-name" data-id="<%=i%>"><%= prod.nameProduct %></td>
                        <td class="product-description" data-id="<%=i%>"><%= prod.descriptionProduct%></td>
                        <td class="product-unit" data-id="<%=i%>"><%= prod.unit%></td>
                        <td>
                            <button id="orderItem" class="btn btn-outline-primary my-2 my-sm-0 btnOrder" type="button" data-id="<%=i%>" data-toggle="tooltip" title="Agrega <%=prod.nameProduct%> al pedido">
                                <ion-icon name="receipt-outline" class="pr-1"></ion-icon> Pedido
                            </button>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>

        <div>

        </div>

        
        <div class="row">
            <form action="/add-order" method="POST">
                <h3>Realizar Pedidos</h3>
                <div id="formOrder" class="container-fluid px-lg-5 px-3 mb-4">
                    <input type="text" value="<%=doc_title%>" name="module" hidden> <!-- No eliminar permite obtener el nombre de la pagina actual -->
                </div>
                <div class="form-group">
                    <button class="btn btn-outline-primary my-2 my-sm-0 btn-block" id="Gdisabled" disabled>Guardar</button>
                </div>
                <br>
            </form>
        </div>
        
    </div>
    <br>
    <%- include('../includes/foot.ejs') %>
    </section>
<%- include('../includes/scripts.ejs') %>
<script>
    let buttonsOrder = $('.btnOrder');

const joinWindowPath = (path) => {
    let newPath = window.location.href,
        l = newPath.length;

    if (newPath[l - 1] == '/')
        newPath = newPath.slice(0, l - 1);
    if (path[0] != '/')
        path = '/' + path;

    return newPath + path
}

const createOrder = (e) => {
    const itemID = e.target.dataset.id;
    const formOrder = $('#formOrder'); //Obtienes el div del formulario
    const productName = $(`.product-name[data-id="${itemID}"]`)[0].innerText; //Obtienes el nombre de la tabla
    const unit = $(`.product-unit[data-id="${itemID}"]`)[0].innerText; //Obtienes la unidad de la tabla
    const des = $(`.product-description[data-id="${itemID}"]`)[0].innerText;
    const button = document.getElementById('Gdisabled');    

    // Si no existe, añádelo
    if (!$(`#formOrder .row[data-id="${itemID}"]`).length)
        formOrder.append(`
            <div class="row order-item" data-id="${itemID}">
            <h4>Pedido <strong>${productName}</strong></h4>
                <div class="col-4 m-auto">
                    <div class="form-floating">
                        <input class="form-control prod-name"
                            type="text" placeholder="." value="${productName.trim()}" name="pdOrd" readonly/>
                        <label>
                            Nombre:
                        </label>
                    </div>
                </div>

                <div class="col-4 col-lg-2 m-auto py-2">
                    <div class="form-floating">
                        <input class="form-control prod-qty"
                            type="number" placeholder="." value="0" min="0" max="9999" name="qntyOrd"/>
                        <label>
                            Cantidad:
                        </label>
                    </div>
                </div>

                <div class="col-4 m-auto py-2">
                    <div class="form-floating">
                        <input class="form-control prod-unit"
                            type="text" placeholder="." value="${unit.trim()}" name="unitOrd" readonly/>
                        <label>
                            Unidad de medida:
                        </label>
                    </div>
                </div>

                <div class="col-6 m-auto py-2">
                    <div class="form-floating">
                        <input class="form-control prod-des"
                            type="text" placeholder="." value="${des.trim()}" name="desOrd" readonly/>
                        <label>
                            Descripción:
                        </label>
                    </div>
                </div>

                <div class="col-6 col-lg-6 m-auto py-2">
                    <div class="form-floating">
                        <textarea class="form-control prod-notes"
                            cols="30" rows="10" name="noteOrd"></textarea>
                        <label>
                            Notas / Comentarios:
                        </label>
                    </div>
                </div>
            </div>
        `);

        if(productName){
            button.removeAttribute('disabled', 'disabled');
        }
    }

    if (buttonsOrder.length)
    buttonsOrder.on('click', createOrder);
</script>

<%- include('../includes/footer.ejs') %>