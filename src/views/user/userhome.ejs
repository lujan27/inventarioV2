    <%- include('../includes/sidebar.ejs') %>
    <%- include('../includes/header.ejs') %>

    <body>

        <section class="home-section">
            <%- include('../includes/nav.ejs') %>
        <div class="container mt-4">
        <%- include('../includes/alerts.ejs') %>

            <div class="container-fluid pt-4 mt-4">
                <div class="subcontenedor">
                    <div class="bloque activo">
                        <div class="justify-content-center row">
                            
                            <h2>Inventario en: <%= user.ranch %> </h2>
                            
                            <table id="inventoryTable" data-column-orderable="1, 0, 0, 1, 0, 0" class="w-100 data-table table table-striped">
                                <thead class="thead">
                                    <tr>
                                        <th>Materia prima</th>
                                        <th>Descripción</th>
                                        <th>Cantidad</th>
                                        <th>Unidad de medida</th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                <% if(stockPrin != null) { %>
                                    <% stockPrin.forEach((data, i)=> { %> 
                                    <tr data-id="<%= data._id %>">
                                        <td class="product-name" data-id="<%=i%>"><%= data.name %></td>
                                        <td class="product-description"  data-id="<%=i%>"><%= data.description %></td>
                                        <td><%= data.quantity %></td>
                                        <td class="product-unit" data-id="<%=i%>"><%= data.unit %></td>
                                        <td>
                                            <% if(data.quantity == 0) {%>
                                                <button id="orderItem" class="btn btn-outline-dark btnOrder" type="button" data-id="<%= i %>" disabled>
                                                    <ion-icon name="receipt-outline" class="pr-1"></ion-icon> Usos
                                                </button>
                                            <% } else { %> 
                                            <a id="orderItem" class="btn btn-outline-primary my-2 my-sm-0 btnOrder" type="button" href="uses/<%=data._id%>" data-toggle="tooltip" title="Registra el uso de <%=data.name%> para descontarlo del inventario">
                                                <ion-icon name="receipt-outline" class="pr-1"></ion-icon> Usos
                                            </a>
                                            <% } %> 
                                        </td>
                                        <td>
                                            <button id="orderItem" class="btn btn-outline-primary my-2 my-sm-0 btnOrder" type="button" data-id="<%=i%>" data-toggle="tooltip" title="Agrega <%=data.name%> al pedido">
                                                <ion-icon name="receipt-outline" class="pr-1"></ion-icon> Pedido
                                            </button>
                                        </td>
                                    </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="5">
                                            No existe información
                                        </td>
                                    </tr>
                                <% } %>
                                </tbody>
                                <caption class="pl-2">Inventario Principal</caption>
                            </table>
            
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <form class="mb-5 pb-5" action="/add-order" method="post">
                    <h3>Realizar Pedidos</h3>
                    <div id="formOrder" class="container-fluid px-lg-5 px-3 mb-4">
                        <input type="text" value="<%=doc_title%>" name="module" hidden> <!-- No eliminar, permite obtener el nombre de la pagina actual -->
                        <input id="role" value="<%=user.role%>" hidden>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline-primary btn-block" id="Gdisabled" disabled>Guardar</button>
                    </div>
                    <br>
                </form>
            </div>

        </div>

        <br>
<%- include('../includes/foot.ejs') %>
    </section>

<%- include('../includes/scripts.ejs') %>

<script>
    let buttonsOrder = $('.btnOrder');

    const joinWindowPath = (path) => {
        let newPath = window.location.href,
            l = newPath.length;

        if (newPath[l - 1] == '/')
            newPath = newPath.slice(0, l - 1);
        if (path[0] != '/')
            path = '/' + path;

        return newPath + path
    }

    const createOrder = (e) => {
        const itemID = e.target.dataset.id;
        const formOrder = $('#formOrder'); //Obtienes el div del formulario
        const productName = $(`.product-name[data-id="${itemID}"]`)[0].innerText; //Obtienes el nombre de la tabla
        const unit = $(`.product-unit[data-id="${itemID}"]`)[0].innerText; //Obtienes la unidad de la tabla
        const des = $(`.product-description[data-id="${itemID}"]`)[0].innerText;
        const button = document.getElementById('Gdisabled');    

        // Si no existe, añádelo
        if (!$(`#formOrder .row[data-id="${itemID}"]`).length)
            formOrder.append(`
                <div class="row order-item" data-id="${itemID}" id="product-${itemID}">
                <h4>Pedido <strong>${productName}</strong></h4>
                    <div class="col-4 m-auto">
                        <div class="form-floating">
                            <input class="form-control prod-name"
                                type="text" placeholder="." value="${productName.trim()}" name="pdOrd" readonly/>
                            <label>
                                Nombre:
                            </label>
                        </div>
                    </div>

                    <div class="col-4 col-lg-2 m-auto py-2">
                        <div class="form-floating">
                            <input class="form-control prod-qty"
                                type="number" placeholder="." value="" min="1" max="9999" name="qntyOrd" required/>
                            <label>
                                Cantidad:
                            </label>
                        </div>
                    </div>

                    <div class="col-4 m-auto py-2">
                        <div class="form-floating">
                            <input class="form-control prod-unit"
                                type="text" placeholder="." value="${unit.trim()}" name="unitOrd" readonly/>
                            <label>
                                Unidad de medida:
                            </label>
                        </div>
                    </div>

                    <div class="col-4 m-auto py-2">
                        <div class="form-floating">
                            <input class="form-control prod-des"
                                type="text" placeholder="." value="${des.trim()}" name="desOrd" readonly/>
                            <label>
                                Descripción:
                            </label>
                        </div>
                    </div>

                    <div class="col-4 col-lg-6 m-auto py-2">
                        <div class="form-floating">
                            <textarea class="form-control prod-notes"
                                cols="30" rows="10" name="noteOrd" required></textarea>
                            <label>
                                Notas / Comentarios:
                            </label>
                        </div>
                    </div>

                    <div class="col-4 col-lg-6 m-auto py-2">
                        <div class="form-floating">
                            <a class="btn btn-outline-primary my-2 my-sm-0 btn-block" id="delete-${itemID}">Quitar</a>
                        </div>
                    </div>
                </div>
            `);

            if(productName){
                button.removeAttribute('disabled', 'disabled');
            }

            var prod_form = document.getElementById('product-'+itemID);

            $(document).ready(function() {
                $("#delete-"+itemID).click(function(event) {
                    // console.log(prod_form);
                    $(prod_form).remove();
                });		
            });
        }

    if (buttonsOrder.length)
    buttonsOrder.on('click', createOrder);
</script>

<br>
<%- include('../includes/footer.ejs') %>